<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>王品電子菁英</title>
    <!--[if lt IE 10]>
    <script>alert('請使用IE10以上或Ghrome瀏覽器閱覽本站哦，謝謝');</script>    
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="css/pace.css"><script type="text/javascript" src="js/pace.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/main.js"></script>
    <link rel="stylesheet" href="css/apply.css">
    <link href="css/bootstrap-material-design.min.css" rel="stylesheet">
</head>

<body>
    <header class="p1"></header>
    <div class="slider-wrapper theme-default">
        <div id="slider" class="nivoSlider"></div>
    </div>
    <div class="slideTitle"></div>
    <div class="content">
        <div class="t1">
            <i class="demo-icon icon-gift">&#xe801;</i>
            <hr> 領取電子優惠
        </div>

        <div class="box coupon qrPage">
            <div class="container card">
                <div class="ticket">
                    <div class="lt-Title">
                        <p id="prizename">xxxx</p>
                    </div>
                    <div class="qr" id="ticqrcode">
                        <div id="qrcode" class="barcode img-responsive" style="margin-top: 50px"></div>
                        <!--
                        <p class="qr-code" id="qrcodeCanvas">
                            本條碼每分鐘自動更新<br />
                        </p>-->
                        <p class="sn" id='cpbtBarcode' style="font-size: 20px"></p>
                        <p class="sn" id='txtcountsec' style="font-size: 20px"></p>
                    </div>
                    <div class="qrFoot">
                        <div class="notice">
                            <h3>注意事項</h3>
                            <ul>
                                <li id="cpprules"></li>
                                <li id="cpbEndDate"></li>
                            </ul>
                            <br/>
                        </div>
                        <div class="productImg">
                            <img id="couponpic" src="" alt="">
                        </div>
                    </div>
                </div>


                <div class="LT"></div>
                <div class="RB"></div>
            </div>
        </div>
    </div>
    <div class="footer"></div>
    <script src="js/material.min.js"></script>
    <script src="WPJS/base.js"></script>
    <script src="WPJS/member.js"></script>
    <script src="WPJS/qrcode.js"></script>
    <script src="WPJS/voucher.js"></script>
    <!-- <script src="WPJS/qrcode.setting.js"></script> -->

    <script>

        var qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 100,
            height: 100
        });

        var cqkey = getUrlParameter("cpbpKey");

        $(function () {
            if(typeof(loadSessionStorage("user_id"))=="undefined" || loadSessionStorage("user_id")=='')
            {
                saveSessionStorage('backurl','coupon-tickets.html');
                window.location.href="memLogin.html";
            }

            $.material.init();
            if (cqkey == '' || cqkey == undefined)
            {
                window.location.href='memLogin.html';
            }

            voucher_detail(cqkey, function (result) {
                if (result == null) {
                    alert("請重新操作！");
                    logout();
                }
                else {
                    $('#prizename').html(result.vcdf_name);
                    $('#cpprules').html(result.vcdf_rule1);
                    $('#cpbEndDate').html('使用期限至' + result.d_expire + '止');
                    $('#couponpic').attr("src", result.vcdf_pic1);

                    qrcode.makeCode(result.vocr_barcode);
                    $('#cpbtBarcode').html(result.vocr_barcode);
                }
            });


            //reload_page();
            //coundown();
            // setInterval(reload_page,60000);  //60秒重複一次
        });


        function reload_page() {
            //console.log("page reload ...");

            refreshBarcode(cqkey, $('#cpbtBarcode'), $('#qrcodeCanvas'), function (result) {
                if (result != null) {
                    $('#cpbtBarcode').html(result);
                    // $('#qrcodeCanvas').text('本條碼每分鐘自動更新');
                    qrcode.makeCode(result);
                }
                else {
                    window.location.href = 'coupon-tickets.html';
                }
            });
        }

        var waitsec = 60;

        function coundown() {
            waitsec = waitsec - 1
            saveSessionStorage('ss', waitsec);
            z = waitsec % 60
            $("#qrcodeCanvas").text('本條碼每分鐘自動更新');
            if (waitsec == 0) {
                waitsec = 60;

            }
            setTimeout("countSec()", 1000)
        }

        x = 0;
        function countSec() {
            if (typeof (loadSessionStorage("ss")) != "undefined" || loadSessionStorage("ss") > 0) {
                waitsec = loadSessionStorage("ss");
            }
            else {
                api_resendcode($('#mobile').val());
            }
            waitsec = waitsec - 1
            saveSessionStorage('ss', waitsec);
            z = waitsec % 60
            $('#txtcountsec').text(z);
            if (waitsec == 0) {
                waitsec = 60;
                reload_page();
                coundown();
                return;
            }
            setTimeout("countSec()", 1000)
        }


    </script>
</body>

</html>
