
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- <link rel="icon" href="../../favicon.ico"> -->
  <link rel="icon" href="https://userfiles-dev.iiot.io/businesses/p8WGlOzZ6/U_lxBlVKvBg">
  <meta property="og:description" content="TEST ABCD">

  <title>
    JETFI JP | 
  </title>

  <!-- Bootstrap core CSS -->
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
  <!-- <link href="https://getbootstrap.com/docs/3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->

  <!-- <link rel="stylesheet" href="https://assets.iiot.io/plugins/bootstrap/css/bootstrap.min.css"> -->

  <!-- 變成material design -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.3/materia/bootstrap.min.css"> -->

  <!-- reference -->
  <!-- <link rel='stylesheet' href='/styles/bootswatch/custom-flatly.min.css'> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/cerulean/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/cosmo/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/superhero/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/paper/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/lumen/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/readable/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/standable/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/simplex/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/united/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/superhero/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/slate/bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.min.css">
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/yeti/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/cyborg/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/journal/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/spacelab/bootstrap.min.css"> -->
  <!-- <link rel="stylesheet" href="https://bootswatch.com/4/minty/bootstrap.min.css"> -->

  <!-- <link rel='stylesheet' href='https://unpkg.com/formiojs@latest/dist/formio.full.min.css'> -->
  <!-- <script src='https://unpkg.com/formiojs@latest/dist/formio.full.js'></script> -->
  <!-- <script src='https://unpkg.com/formiojs@latest/dist/formio.utils.js'></script> -->
  <link rel='stylesheet' href='https://wifiotg-kay.iiot.io/styles/formio.full.min.css'>

  <!-- custom css -->
  <!-- <link rel='stylesheet' href='/styles/booking-style.css'> -->
  <link rel='stylesheet' href='assets/style.css'>
  <link rel="stylesheet" href="https://wifiotg-kay.iiot.io/styles/booking-print.css" type="text/css" media="print" />

  <script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>

  <script src='https://wifiotg-kay.iiot.io/scripts/formio.full.min.js'></script>

  <!-- <script src='/scripts/formio.utils.js'></script> -->

  <!-- moment -->
  <script src="https://momentjs.com/downloads/moment-with-locales.js"></script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript">
    $(function () {
      $(".mob_cart").click(function () {
        $('#orderpreview').slideToggle(800);
      });
      return false;
    });
  </script>

  <script type='text/javascript'>
    var handleQS = function () {
      var url_string = window.location.href; //window.location.href
      var url = new URL(url_string);
      var query = {
        token: "example",
        campaignId: url.searchParams.get("campaignId"),
        campaignType: url.searchParams.get("campaignType"),
        businessId: url.searchParams.get("businessId")
      }
      var qs = '?token=example';

      if (query.campaignId)
        qs += '&campaignId=' + query.campaignId;

      if (query.campaignType)
        qs += '&campaignType=' + query.campaignType;

      if (query.businessId)
        qs += '&businessId=' + query.businessId;

      return qs;
    };

    var amtUpdate = function (amt, submission) {
      // footer 更新
      // document.getElementById('amt-footer').innerHTML = '<p>' + FormioUtils.formatAsCurrency(amt) + '</p>';
      document.getElementById('amt-total').innerHTML = FormioUtils.formatAsCurrency(amt);
      // preview 更新
      // var departureDate = '';
      // if (submission.data.departureDate) {
      //   departureDate = moment(submission.data.departureDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      // }
      // var arrivalDate = '';
      // if (submission.data.arrivalDate) {
      //   arrivalDate = moment(submission.data.arrivalDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      // }

      // document.getElementById('order-date').innerHTML = '<span>' + departureDate + ' To ' + arrivalDate + '</span>'
    }

    var updatePickupDate = function (event) {
      // console.log('NNNN the update pickup event ' + JSON.stringify(event.data));
      if (!globalMap)
        globalMap = {};
      if (!globalMap.pickupOffsetMap)
        globalMap.pickupOffsetMap = {};

      var freePickupInAdvance = 0;  // 不需要加錢的情況 --> 要根據物流方式...
      var deliveryDays = 0;
      if (event.data.pickupTab && event.data.pickupMethodValues[event.data.pickupTab]) {
        // console.info('from tab');
        if (typeof globalMap.pickupOffsetMap[event.data.pickupMethodValues[event.data.pickupTab]] === 'number') {
          freePickupInAdvance = globalMap.pickupOffsetMap[event.data.pickupMethodValues[event.data.pickupTab]];
          deliveryDays = globalMap.deliveryMap[event.data.pickupMethodValues[event.data.pickupTab]];
        }
      } else if (event.data.subPickupMethodValue) {
        // console.info('from sub');
        if (typeof globalMap.pickupOffsetMap[event.data.subPickupMethodValue] === 'number') {
          freePickupInAdvance = globalMap.pickupOffsetMap[event.data.subPickupMethodValue];
          deliveryDays = globalMap.deliveryMap[event.data.subPickupMethodValue];
        }
      } else if (!event.data.pickupMethodValues && event.data.pickupMethodValue) {
        if (event.data.pickupMethodValue.indexOf('group') > -1) {
          // 要看sub, 會進到這邊代表選了group但沒選sub
          // console.log('skip, use the default pickup in advance free 0');
        } else {
          // console.info('from primary ' + event.data.pickupMethodValue);
          if (typeof globalMap.pickupOffsetMap[event.data.pickupMethodValue] === 'number') {
            freePickupInAdvance = globalMap.pickupOffsetMap[event.data.pickupMethodValue];
            deliveryDays = globalMap.deliveryMap[event.data.pickupMethodValue];
          }
        }

      }
      // console.log('check the free pickup in advance ' + freePickupInAdvance);
      // console.log('check the charge ' + event.data.pickupInAdvance);

      if (event.data.departureDate) {

        var pickupInAdvance = freePickupInAdvance;
        if (event.data.pickupInAdvance)
          var pickupInAdvance = event.data.pickupInAdvance + freePickupInAdvance;

        console.log('the Inadvance date ' + pickupInAdvance);
        var pickupDate = moment(event.data.departureDate).add(-1 * pickupInAdvance, 'day');

        console.log(pickupDate.format());
        return {
          pickupDate: pickupDate,
          freePickupInAdvance: freePickupInAdvance,
          deliveryDays: deliveryDays
        }
      } else {
        return null;
      }
    }

    var previewUpdate = function (event) {
      // 不能顯示value...要顯示對應出來的方案...囧
      if (!event.data)
        event.data = {};

      if (!globalMap)
        globalMap = {
          pickupMap: {},
          subPickupMap: {},
          returnMap: {},
          pickupOffsetMap: {}
        };

      if (event.data.pickupTab && event.data.pickupMethodValues) {
        // 牽扯到group有點囧...
        event.data.pickupMethodValue = event.data.pickupMethodValues[event.data.pickupTab] || event.data.pickupMethodValues['group'];
      }

      // console.log('the tab and value ' + event.data.pickupTab + ' and ' + JSON.stringify(event.data.pickupMethodValues));
      // console.log('the map ' + JSON.stringify(globalMap.pickupMap));
      // console.log('so the label should be ' + globalMap.pickupMap[event.data.pickupMethodValue]);

      var pickupMethodLabel = (globalMap.pickupMap ? globalMap.pickupMap[event.data.pickupMethodValue] || '' : '');
      var subPickupMethodLabel = (globalMap.subPickupMap ? globalMap.subPickupMap[event.data.subPickupMethodValue] || '' : '');
      var returnMethodLabel = (globalMap.returnMap ? globalMap.returnMap[event.data.returnMethodValue] || '' : '');
      document.getElementById('pickup-method').innerHTML = '<span>' + pickupMethodLabel + '<br>' + subPickupMethodLabel + '</span>'
      document.getElementById('return-method').innerHTML = '<span>' + returnMethodLabel + '</span>';

      // if (event.data.departureDate) {
      //   var pickupInAdvance = 1; // default
      //   if (event.data.pickupInAdvance)
      //     pickupInAdvance = event.data.pickupInAdvance;
      //   document.getElementById('pickup-date-result').innerHTML = '<span>' + moment(event.data.departureDate).add(-1 * pickupInAdvance, 'day').format('YYYY-MM-DD') + '</span>'
      // }
      if (event.data.pickupDate) {
        document.getElementById('pickup-date-result').innerHTML = '<span>' + event.data.pickupDate + '</span>'
        document.getElementById('pickup-date').innerHTML = '<span>' + event.data.pickupDate + '</span>'
      }

      // preview 更新
      var departureDate = '';
      if (event.data.departureDate) {
        departureDate = moment(event.data.departureDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      }
      var arrivalDate = '';
      if (event.data.arrivalDate) {
        arrivalDate = moment(event.data.arrivalDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      }

      if (!departureDate && !arrivalDate) {
      }
      else {
        document.getElementById('order-date').innerHTML = '<span>' + departureDate + ' ~ ' + arrivalDate + '</span>';
      }

      if (departureDate && arrivalDate && event.data.qty) {
        tmpSaveOrder();
        document.getElementById('estimate-dl-button').disabled = false;
      } else {
        document.getElementById('estimate-dl-button').disabled = true;
      }

      // if (event.isValid) {
      //   document.getElementById('form-submit-button').disabled = false;
      // } else {
      //   document.getElementById('form-submit-button').disabled = true;
      // }

      if (event.data.qty) {
        document.getElementById('device-qty').innerHTML = '<span>' + event.data.qty + '</span>'
      }
    }

    var mainForm, mainComponents, globalMap = {};

    var tmpSaveOrder = function () {
      // 要先暫存資訊才開視窗
      var event = mainForm.submission.data;
      event.skipAmt = false;
      // console.log('jppost event');
      // console.log(submission);
      // alert('Submission sent to custom endpoint. See developer console.');
      return fetch('/apis/booking-form', {
        body: JSON.stringify(event),
        headers: {
          'content-type': 'application/json'
        },
        method: 'POST',
        mode: 'cors',
      })
        .then(response => {

          response.json().then((result) => {
            // window.location = 'http://127.0.0.1:8080/order.html'
            // window.open('/modules/booking-estimate-v2?token=example', 'winname', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=600,height=600');
          });
        })
    }
    var openEstimate = function () {

      window.open(
        // '/modules/booking-estimate-v2?token=example'
        '/modules/booking-estimate-v2' + handleQS()
        , 'winname', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=600,height=800');
    }

    window.onload = function () {
      // Formio.setBaseUrl(window.location.origin);
      Formio.setBaseUrl('https://wifiotg-kay.iiot.io');
      // Formio.createForm(document.getElementById('formio'), 'https://wifiotg-kay.iiot.io/apis/booking-form')
      Formio.createForm(document.getElementById('bookingform'),
        // '/apis/booking-form?token=example'
        '/apis/booking-form' + handleQS()
        , {
          readOnly: false,
          viewAsHtml: false // 這個可以拿來做訂單確認

        }
      )
        .then(function (form) {
          mainForm = form;
          window.setLanguage = function (lang) {
            form.language = lang;
          };

          // 已經有資料的話，就將資料更新進來
          // initial form data
          fetch(
            // '/apis/booking-form?token=example'
            'https://wifiotg-kay.iiot.io/apis/booking-form' + handleQS()
            , {
              headers: {
                'content-type': 'application/json'
              },
              method: 'GET',
              mode: 'cors',
            })
            .then(response => {

              var submission = { data: {} };
              response.json().then(function (result) {

                if (result && result.data) {
                  submission.data = result.data;
                  if (result.data.amtReview) {
                    amtUpdate(result.data.amtReview, submission);
                  }
                  // 預設的arrivalDate
                  submission.data.departureDate = (submission.data.departureDate ? submission.data.departureDate : form.submission.data.departureDate);
                  submission.data.arrivalDate = (submission.data.arrivalDate ? submission.data.arrivalDate : submission.data.departureDate);
                  // submission.data.pickupDateResult = (submission.data.pickupDateResult ? submission.data.pickupDateResult : moment(form.submission.data.departureDate).add(-1, 'days').format('YYYY-MM-DD HH:mm:ss+Z'));

                  var pickupObj = updatePickupDate(submission);

                  // var pickupDate = updatePickupDate(submission);
                  if (pickupObj) {
                    var pickupDate = pickupObj.pickupDate;
                    submission.data.freePickupInAdvance = pickupObj.freePickupInAdvance;
                    submission.data.deliveryDays = pickupObj.deliveryDays;
                    submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');
                  }

                  form.submission = submission;

                  form.submission = submission;
                  mainComponents = result.components;
                  globalMap = result.map;
                  previewUpdate(form.submission);
                  form.emit('countDeadline', submission.data);

                  // 第一次trigger一下event來更新arrivalDate區間？（已經有值的話不能被改)

                  // console.log('update done ' + JSON.stringify(result.components));
                }
              })
            });

          var zipTimer;
          // Triggered when they click the submit button.
          form.on('change', function (event) {
            // 有時候key是number (加購項目...)

            // 領還轉換
            // if (event && event.data && event.data.pickupTab && event.data.pickupMethodValues[event.data.pickupTab]) {

            //   // if (event.changed.component.key.indexOf('pickupMethodValues') > -1) {
            //   //   console.log('check skip ------- ');
            //   //   if (event.data.pickupMethodValue === event.data.pickupMethodValues[event.data.pickupTab]) {
            //   //     console.log('direct return ' + event.data.pickupMethodValue + ' vs ' + event.data.pickupMethodValues[event.data.pickupTab]);
            //   //     console.log('direct tab ' + event.data.pickupTab);
            //   //     return;
            //   //   }
            //   // }
            //   // var submission = { data: event.data };
            //   // submission.data.pickupMethodValue = submission.data.pickupMethodValues[submission.data.pickupTab];
            //   event.data.pickupMethodValue = event.data.pickupMethodValues[event.data.pickupTab];
            //   // form.submission = submission;
            // }
            // console.log('the key ' + event.changed.component.key);
            if (event.changed && (event.changed.component.key === 'jpzip1' || event.changed.component.key === 'jpzip2')) {
              // console.log('ok?');
              clearTimeout(zipTimer);
              zipTimer = setTimeout(function () {

                form.emit('autoYubinbango', event.data);
              }, 500);
              // form.emit('autoYubinbango', event);
            }

            // 轉換一下pickupDate, 更換物流方式的時候也需要...           
            if (event.changed && typeof event.changed.component.key === 'string'
              && (event.changed.component.key.indexOf('pickupInAdvance') > -1)) {
              console.log('change pickup in advance');
              var submission = { data: event.data };

              submission.data.pickupInAdvance = event.data[event.changed.component.key] || 0;

              // var pickupDate = updatePickupDate(event);
              var pickupObj = updatePickupDate(event);

              if (pickupObj) {
                var pickupDate = pickupObj.pickupDate;
                submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');
                submission.data.freePickupInAdvance = pickupObj.freePickupInAdvance;
                submission.data.deliveryDays = pickupObj.deliveryDays;
              }

              form.submission = submission;
              form.emit('countDeadline', event.data);
            }
            if (event.changed && typeof event.changed.component.key === 'string'
              && event.changed.component.key === 'departureDate') {
              var submission = { data: event.data };
              delete submission.data.pickupInAdvance;

              // var pickupDate = updatePickupDate(event);
              var pickupObj = updatePickupDate(event);

              if (pickupObj) {
                var pickupDate = pickupObj.pickupDate;
                submission.data.freePickupInAdvance = pickupObj.freePickupInAdvance;
                submission.data.deliveryDays = pickupObj.deliveryDays;
                submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');
              }

              form.submission = submission;
              form.emit('countDeadline', event.data);
            }

            if (event.changed && typeof event.changed.component.key === 'string'
              && event.changed.component.key === 'pickupTab') {
              delete form.submission.data.pickupInAdvance;

              // var submission = { data: event.data };
              // delete submission.data.pickupInAdvance;

              // var pickupDate = updatePickupDate(event);
              var pickupObj = updatePickupDate(event);

              if (pickupObj) {
                var pickupDate = pickupObj.pickupDate;
                form.submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');
                form.submission.data.freePickupInAdvance = pickupObj.freePickupInAdvance;
                form.submission.data.deliveryDays = pickupObj.deliveryDays;
              }
              form.emit('countDeadline', event.data);
              // form.submission = submission;
            }
            // console.log('pickupObj free in advance ' + (pickupObj ? pickupObj.freePickupInAdvance : 'not yet'));
            // console.log('after free in advance ' + form.submission.data.freePickupInAdvance);

            // Or you can check it manually with. (不大會用...)
            // var isValid = form.checkValidity(event.data);
            // var isValid = form.checkValidity(form.submission.data);

            // 動態計算價格
            // console.log(event);
            // 判斷 key 是否影響價格？
            // 即可動態決定價位顯示
            // 一定要判斷否則會無窮迴圈

            // console.log(event.changed.component);
            // 日期相關
            if (event.changed && event.changed.component
              && event.changed.component.key === 'departureDate') {
              for (var i = 0; i < mainComponents.length; ++i) {

                if (mainComponents[i].key === 'datePanel' && mainComponents[i].components) {
                  for (var j = 0; j < mainComponents[i].components.length; ++j) {

                    if (mainComponents[i].components[j].key === 'bookingDate' && mainComponents[i].components[j].columns) {
                      // 針對arrival改變
                      if (mainComponents[i].components[j].columns[1] && mainComponents[i].components[j].columns[1].components) {
                        for (var k = 0; k < mainComponents[i].components[j].columns[1].components.length; ++k) {
                          if (mainComponents[i].components[j].columns[1].components[k].key === 'arrivalDate') {
                            mainForm.emit('departureChange', event);
                            // mainForm.setForm({components: mainComponents});
                            // break;
                          }
                        }
                      }

                    }
                  }
                }
              }
            }

            if (event.changed && event.changed.component
              && (
                event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'qty')
            ) {

              // 更改過影響加購的資訊的話，要清空addons!!
              var submission = { data: event.data };
              delete submission.data.addons;
              form.submission = submission;
            }

            // console.log('the value is ', event.data);
            // console.log('the pickup tab ' + event.data.pickupTab);
            // 好像是因為conditional的關係，這邊如果判斷了pickupMethodValues,會導致無限迴圈...
            if (event.changed &&
              typeof event.changed.component.key === 'string' &&
              (event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'pickupMethodValue'
                || event.changed.component.key === 'returnMethodValue'
                || event.changed.component.key === 'subPickupMethodValue'
                // || event.changed.component.key === 'pickupTab'
                || (event.changed.component.key.indexOf('pickupMethodValues') > -1)
                || (event.changed.component.key.indexOf('pickupInAdvance') > -1)
                || event.changed.component.key === 'qty'
              )
            ) {
              // console.log('go fetch https://wifiotg-kay.iiot.io/apis/booking-est');
              // console.log(form.components[1].component);


              // var pickupDate = updatePickupDate(event);
              var pickupObj = updatePickupDate(event);

              if (pickupObj) {
                var pickupDate = pickupObj.pickupDate;
                event.data.pickupDate = pickupDate.format('YYYY-MM-DD');
                form.submission.data.freePickupInAdvance = pickupObj.freePickupInAdvance;
                form.submission.data.deliveryDays = pickupObj.deliveryDays;
              }
              form.emit('countDeadline', event.data);

              // console.log('should update pickup date ' + JSON.stringify(pickupDate));
              previewUpdate(event);

              // console.log('change ' + form.components[1].component.content  + ' to update by fe');
              // form.components[1].component.content = 'update by fe';
              // form.render();
              // event.data裡面有目前的data, 要透過這個來計算價位
              fetch('/apis/booking-est', {
                body: JSON.stringify(event.data),
                method: 'POST',
                headers: {
                  'content-type': 'application/json'
                },
                mode: 'cors',
              })
                .then(function (response) {

                  response.json().then(function (result) {
                    console.log('values ' + JSON.stringify(event.data.pickupMethodValues));
                    console.log('the form submission ' + JSON.stringify(form.submission.data.pickupMethodValues));
                    if (event.changed.component.key.indexOf('pickupMethodValues') > -1) {
                      if (result && result.total) {
                        form.submission.data.amtReview = result.total;
                        amtUpdate(result.amt, form.submission);
                      }
                      return;
                    }
                    var submission = { data: event.data };
                    // {"total":120,"amt":120,"days":1,"shipment":0,"price":50}
                    if (result && result.total) {
                      submission.data.amtReview = result.total;
                      // submission.data.pickupMethodValues = event.data.pickupMethodValues;
                      amtUpdate(result.amt, submission);
                      form.submission = submission; // 加這個好像會無限輪迴....
                    } else {
                      submission.data.amtReview = 0;
                      form.submission = submission;
                    }

                  });
                });
            }

            // add on 相關
            if (event.changed && (typeof event.changed.component.key === 'number' || (event.changed.component.key.indexOf('addons') > -1) || (event.changed.component.key.indexOf('%$@') > -1))) {

              // console.log('change ' + form.components[1].component.content  + ' to update by fe');
              // form.components[1].component.content = 'update by fe';
              // form.render();
              // event.data裡面有目前的data, 要透過這個來計算價位
              fetch('/apis/booking-est', {
                body: JSON.stringify(event.data),
                method: 'POST',
                headers: {
                  'content-type': 'application/json'
                },
                mode: 'cors',
              })
                .then(function (response) {

                  response.json().then(function (result) {

                    var submission = { data: event.data };
                    // {"total":120,"amt":120,"days":1,"shipment":0,"price":50}
                    if (result && result.amt) {
                      submission.data.amtReview = result.amt;
                      amtUpdate(result.amt);
                      form.submission = submission;
                      console.log(form.submission);
                    } else {
                      submission.data.amtReview = 0;
                      form.submission = submission;
                    }

                  });
                });
            }
          });

          // Prevent the submission from going to the form.io server.
          form.nosubmit = true;

          form.on('jppost', (event) => {
            event.skipAmt = true;
            console.log('jppost event');
            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              body: JSON.stringify(event),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.jppostUrl;
                });
              })
          })
          form.on('error', function (e) {
            // e is array, [{component:{label:"xx", key: "pickupMethodValue..."}, message: "取貨方式 is requied"}];
            // console.log('we got the error ', e);

            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
          })
          // Triggered when they click the submit button.
          form.on('submit', function (submission) {

            // 領環轉換
            if (submission && submission.data && submission.data.pickupTab && submission.data.picukupMethodValues) {
              submission.data.pickupMethodValue = submission.data.picukupMethodValues[submission.data.pickupTab] || submission.data.pickupMethodValue;
            }
            if (submission.data.subPickupMethodValue && globalMap.subPickupWmsIdMap) {
              submission.data.pickupWmsId = globalMap.subPickupWmsIdMap[submission.data.subPickupMethodValue];
            } else if (submission.data.pickupMethodValue && globalMap.pickupWmsIdMap) {
              submission.data.pickupWmsId = globalMap.pickupWmsIdMap[submission.data.pickupMethodValue];
            }
            if (submission.data.returnMethodValue && globalMap.returnWmsIdMap) {
              submission.data.returnWmsId = globalMap.returnWmsIdMap[submission.data.returnMethodValue];
            }
            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              // body: JSON.stringify(submission),
              body: JSON.stringify(submission.data),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {
                // submission.data.redirectUrl = response.redirectUrl;
                form.emit('submitDone', submission);

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.redirectUrl;
                });
              })
          });

          form.on('countDeadline', function (event) {

            if (event.pickupTab === 'jpaddress') {
              if (!event.jpzip1 || !event.jpzip2) {
                return;
              }
              $.ajax({
                url: '/apis/booking-deadline?type=' + event.pickupTab + '&zipcode=' + event.jpzip1 + '-' + event.jpzip2,
                // dataType: 'json',
                success: function (data) {

                  if (data && event.pickupDate) {
                    // data example: {"id":78777,"zipcode":"105-0003","days":2,"available_time":8}
                    // booking deadline要在dispatchDate當天0點以前
                    mainForm.submission.data.dispatchDate = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (data.days), 'days').format('YYYY-MM-DD');
                    form.submission.data.dispatchDate = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (data.days), 'days').format('YYYY-MM-DD');
                    mainForm.submission.data.bookingDeadline = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (data.days + 1), 'days').format('YYYY-MM-DD');
                    form.submission.data.bookingDeadline = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (data.days + 1), 'days').format('YYYY-MM-DD');
                    // var submission = { data: mainForm.submission.data };
                    // form.submission = submission;
                  }
                }
              });
            } else {
              console.log('------------ static dispatch date ---------------');
              mainForm.submission.data.dispatchDate = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (event.deliveryDays), 'days').format('YYYY-MM-DD');
              form.submission.data.dispatchDate = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (event.deliveryDays), 'days').format('YYYY-MM-DD');
              mainForm.submission.data.bookingDeadline = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (event.deliveryDays + 1), 'days').format('YYYY-MM-DD');
              form.submission.data.bookingDeadline = moment(event.pickupDate, 'YYYY-MM-DD').add(-1 * (event.deliveryDays + 1), 'days').format('YYYY-MM-DD');
              console.log('pickup date ' + event.pickupDate);
              console.log('event day ' + event.deliveryDays);
              console.log('dispatch date ' + mainForm.submission.data.dispatchDate);
            }

          });

          // form.on('submitDone', function (submission) {
          //   window.location = submission.data.redirectUrl;
          // });
          // ref: https://github.com/yubinbango/yubinbango
          // https://github.com/yubinbango/yubinbango-data
          // 原本jetfijp直接呼叫'https://yubinbango.github.io/yubinbango-data/data/' + event.jpzip1 + '.js'
          // 但這個是jsonp...做一下replace好了
          form.on('autoYubinbango', function (event) {
            console.log('emit autoYubinbango ' + event.jpzip1);
            if (!event.jpzip1 || !event.jpzip2) {
              return;
            }
            $.ajax({
              url: 'https://yubinbango.github.io/yubinbango-data/data/' + event.jpzip1 + '.js',
              // dataType: 'json',
              success: function (data) {

                if (data) {
                  var yubinMap = {};
                  // 刪除 "$yubin(" 以及最後的 ");"
                  // array資訊：
                  // 0: 區域id
                  var prefectureMap = [
                    "北海道",
                    "青森県",
                    "岩手県",
                    "宮城県",
                    "秋田県",
                    "山形県",
                    "福島県",
                    "茨城県",
                    "栃木県",
                    "群馬県",
                    "埼玉県",
                    "千葉県",
                    "東京都",
                    "神奈川",
                    "新潟県",
                    "富山県",
                    "石川県",
                    "福井県",
                    "山梨県",
                    "長野県",
                    "岐阜県",
                    "静岡県",
                    "愛知県",
                    "三重県",
                    "滋賀県",
                    "京都府",
                    "大阪府",
                    "兵庫県",
                    "奈良県",
                    "和歌山",
                    "鳥取県",
                    "島根県",
                    "岡山県",
                    "広島県",
                    "山口県",
                    "徳島県",
                    "香川県",
                    "愛媛県",
                    "高知県",
                    "福岡県",
                    "佐賀県",
                    "長崎県",
                    "熊本県",
                    "大分県",
                    "宮崎県",
                    "鹿児島",
                    "沖縄県"
                  ]
                  data = data.substring(7, data.length - 3);
                  yubinMap = JSON.parse(data);
                  var prefectureData = yubinMap[event.jpzip1 + event.jpzip2];
                  // mainForm.submission.tmp = {
                  //   profilePrefecture: prefectureMap[prefectureData[0] - 1],
                  //   profileMunicipalities1: prefectureData[1],
                  //   profileMunicipalities2: prefectureData[2]
                  // };

                  // 要更新表單
                  // console.log('emit changePrefecture ',mainForm.submission);
                  // form.emit('changePrefecture', event);

                  if (prefectureMap && prefectureData) {
                    mainForm.submission.data.profilePrefecture = prefectureMap[prefectureData[0] - 1];
                    mainForm.submission.data.profileCity = prefectureData[1] + prefectureData[2];
                    var submission = { data: mainForm.submission.data };
                    // console.log('should update the profile prefecture');
                    form.submission = submission;

                    form.emit('countDeadline', event);
                  } else {
                    // 找不到
                  }

                }
              }
            });
            // return fetch('https://yubinbango.github.io/yubinbango-data/data/' + event.jpzip1 + '.js', {
            //   // headers: {
            //   //   'content-type': 'application/json'
            //   // },
            //   method: 'GET',
            //   mode: 'no-cors',
            // })
            // .then(response => {
            //     console.log('response ', response);
            //     response.text().then((text) => {
            //       console.log(text);
            //     });
            //   })
          });
        });
    };
  </script>

</head>

<body>
  <div class="header">
    
    <a class="mob_cart" href="#"><span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span></a>
    <!-- 新增nav bar -->
    <div class="top_step_contents clearfix">
      
      <div class="middle_contents">
        <div class="newLogo">
          <a href="https://www.iiot.io">
            <img class="iiot-logo-image" src="https://userfiles-dev.iiot.io/businesses/p8WGlOzZ6/U_q7KqrR6PG">
          </a>
        </div>
        <div class="stepwizard align-center">
          <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-info btn-circle" disabled="disabled">1</a>
              <p class="">訂單編輯</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">2</a>
              <p class="">訂購者聯絡資訊</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">3</a>
              <p class="">訂單確認與付款</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">4</a>
              <p class="">確認</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    

  <div class="shop_contents clearfix">
    <div class="iiot-main-form">
      <div class="row">
        <div class="col-md-12">
          <div id='bookingform' class="card card-body bg-light null formio-form"></div>
        </div>
      </div>
    </div>

    <div class="orderpreview" id="orderpreview">
      <div class="wellbox">
        <h3 class="top_title"><span>お申込内容</span></h3>
        <div class="a_list clearfix">
          <p class="left_item">レンタル期間</p>
          <p id="order-date">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">プラン名</p>
          <p>
            中國 500MB
          </p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">受取方法</p>
          <p id="pickup-method">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">返却方法</p>
          <p id="return-method">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">お受取り日</p>
          <p id="pickup-date">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">jetfi レンタル台数</p>
          <p id="device-qty">未選択です</p>
        </div>
        <!-- <div class="a_list clearfix">
          <p class="left_item">キャンペーン値引き</p>
          <p>-500円</p>
        </div> -->
        <div class="a_list clearfix">
          <p class="left_item">合計金額(税込)</p>
          <p><span id="amt-total">0</span> 円</p>
        </div>
        <div class="a_list clearfix">
          <!-- <p class="left_item">合計金額(税込)</p>
          <p><span id="amt-total">0</span> 円</p> -->
          <button type="button" id="estimate-dl-button" class="booking-estimate btn btn-outline-dark btn-block"
            onclick="openEstimate()">見積書をダウンロード</button>
            <button type="button" id="form-submit-button" class="btn btn-info btn-block"
            onclick="mainForm.submit()">お申込者情報の入力へ</button>
        </div>
      </div>
    </div>

    <!-- 日本不想要這個，而是希望併入右方preview區域 -->
    <!-- <div class="footer">
      <div class="row">
        <div class="col-md-6 amount-text">
          <p>税込合計: <span id="amt-footer">0</span><i class="icon-shopping-cart icon"></i></p>
        </div>
        <div class="col-md-6 confirm-button-bottom">
          <button type="button" id="estimate-dl-button" class="booking-estimate btn btn-outline-light" onclick="openEstimate()">見積書をダウンロード</button>
          <button type="button" class="btn btn-info" onclick="mainForm.submit()">お申込者情報の入力へ</button>
        </div>
      </div>
    </div> -->


  </div> <!-- /container -->
</body>

</html>