
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- <link rel="icon" href="../../favicon.ico"> -->
  <link rel="icon" href="null">
  <meta property="og:description" content="">

  <title>
    JETFI JP | 
  </title>

  <!-- Bootstrap core CSS -->
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
  <!-- <link href="https://getbootstrap.com/docs/3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->

  <!-- <link rel="stylesheet" href="https://assets.iiot.io/plugins/bootstrap/css/bootstrap.min.css"> -->

  <!-- 變成material design -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.3/materia/bootstrap.min.css"> -->

  <!-- reference -->
  <!-- <link rel='stylesheet' href='/styles/bootswatch/custom-flatly.min.css'> -->
  <link rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.min.css">

  <!-- <link rel='stylesheet' href='https://unpkg.com/formiojs@latest/dist/formio.full.min.css'>
  <script src='https://unpkg.com/formiojs@latest/dist/formio.full.min.js'></script> -->
  <link rel='stylesheet' href='https://wifiotg-kay.iiot.io/styles/formio.full.min.css'>

  <!-- custom css -->
  <link rel='stylesheet' href='./assets/style.css'>

  <script src='https://wifiotg-kay.iiot.io/scripts/formio.full.min.js'></script>

  <!-- moment -->
  <script src="https://momentjs.com/downloads/moment-with-locales.js"></script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript">
    $(function () {
      $(".mob_cart").click(function () {
        $(this).parent().find('.orderpreview').slideToggle(800);
      });
      return false;
    });
  </script>

  <script type='text/javascript'>
    var handleQS = function () {
      var url_string = window.location.href; //window.location.href
      var url = new URL(url_string);
      var query = {
        token: "grmPLZLVNRuBDz",
        campaignId: url.searchParams.get("campaignId"),
        campaignType: url.searchParams.get("campaignType"),
        businessId: url.searchParams.get("businessId")
      }
      var qs = '?token=grmPLZLVNRuBDz';

      if (query.campaignId)
        qs += '&campaignId=' + query.campaignId;

      if (query.campaignType)
        qs += '&campaignType=' + query.campaignType;

      if (query.businessId)
        qs += '&businessId=' + query.businessId;

      return qs;
    };
    
    var amtUpdate = function (amt, submission) {
      // footer 更新
      // document.getElementById('amt-footer').innerHTML = '<p>' + FormioUtils.formatAsCurrency(amt) + '</p>';
      document.getElementById('amt-total').innerHTML =  FormioUtils.formatAsCurrency(amt);
      // preview 更新
      // var departureDate = '';
      // if (submission.data.departureDate) {
      //   departureDate = moment(submission.data.departureDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      // }
      // var arrivalDate = '';
      // if (submission.data.arrivalDate) {
      //   arrivalDate = moment(submission.data.arrivalDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      // }

      // document.getElementById('order-date').innerHTML = '<span>' + departureDate + ' To ' + arrivalDate + '</span>'
    }

    var updatePickupDate = function (event) {
      console.log('the update pickup event ' + JSON.stringify(event));
      if (event.data.departureDate) {
        var pickupInAdvance = 1; // default
        if (event.data.pickupInAdvance)
          pickupInAdvance = event.data.pickupInAdvance;
        // console.log('the Inadvance date ' + pickupInAdvance);
        return moment(event.data.departureDate).add(-1 * pickupInAdvance, 'day');
      } else {
        return null;
      }
    }

    var previewUpdate = function (event) {
      // 不能顯示value...要顯示對應出來的方案...囧
      if (!event.data)
        event.data = {};

      if (!globalMap)
        globalMap = {};

      var pickupMethodLabel = (globalMap.pickupMap ? globalMap.pickupMap[event.data.pickupMethodValue] || '' : '');
      var subPickupMethodLabel = (globalMap.subPickupMap ? globalMap.subPickupMap[event.data.subPickupMethodValue] || '' : '');
      var returnMethodLabel = globalMap.returnMap[event.data.returnMethodValue] || '';
      document.getElementById('pickup-method').innerHTML = '<span>' + pickupMethodLabel + '<br>' + subPickupMethodLabel + '</span>'
      document.getElementById('return-method').innerHTML = '<span>' + returnMethodLabel + '</span>';

      // if (event.data.departureDate) {
      //   var pickupInAdvance = 1; // default
      //   if (event.data.pickupInAdvance)
      //     pickupInAdvance = event.data.pickupInAdvance;
      //   document.getElementById('pickup-date-result').innerHTML = '<span>' + moment(event.data.departureDate).add(-1 * pickupInAdvance, 'day').format('YYYY-MM-DD') + '</span>'
      // }
      if (event.data.pickupDate) {
        document.getElementById('pickup-date-result').innerHTML = '<span>' + event.data.pickupDate + '</span>'
        document.getElementById('pickup-date').innerHTML = '<span>' + event.data.pickupDate + '</span>'
      }

      // preview 更新
      var departureDate = '';
      if (event.data.departureDate) {
        departureDate = moment(event.data.departureDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      }
      var arrivalDate = '';
      if (event.data.arrivalDate) {
        arrivalDate = moment(event.data.arrivalDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY/MM/DD');
      }

      if (!departureDate && !arrivalDate) {
      }
      else {
        document.getElementById('order-date').innerHTML = '<span>' + departureDate + ' To ' + arrivalDate + '</span>';
      }

      if (departureDate && arrivalDate && event.data.qty) {
        tmpSaveOrder();
        document.getElementById('estimate-dl-button').disabled = false;
      } else {
        document.getElementById('estimate-dl-button').disabled = true;

      }

      if (event.data.qty) {
        document.getElementById('device-qty').innerHTML = '<span>' + event.data.qty + '</span>'
      }
    }

    var mainForm, mainComponents, globalMap = {};

    var tmpSaveOrder = function () {
      // 要先暫存資訊才開視窗
      var event = mainForm.submission.data;
      event.skipAmt = false;
      // console.log('jppost event');
      // console.log(submission);
      // alert('Submission sent to custom endpoint. See developer console.');
      return fetch('/apis/booking-form', {
        body: JSON.stringify(event),
        headers: {
          'content-type': 'application/json'
        },
        method: 'POST',
        mode: 'cors',
      })
        .then(response => {

          response.json().then((result) => {
            // window.location = 'http://127.0.0.1:8080/order.html'
            // window.open('/modules/booking-estimate-v2?token=grmPLZLVNRuBDz', 'winname', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=600,height=600');
          });
        })
    }
    var openEstimate = function () {

      window.open(
        // '/modules/booking-estimate-v2?token=grmPLZLVNRuBDz'
        '/modules/booking-estimate-v2' + handleQS()
        , 'winname', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=600,height=800');
    }

    window.onload = function () {
      Formio.setBaseUrl(window.location.origin);
      // Formio.createForm(document.getElementById('formio'), 'https://wifiotg-kay.iiot.io/modules/booking-form')
      Formio.createForm(document.getElementById('bookingform'),
        // '/apis/booking-form?token=grmPLZLVNRuBDz'
        '/apis/booking-form' + handleQS()
        , {
          readOnly: false,
          viewAsHtml: false // 這個可以拿來做訂單確認

        }
      )
        .then(function (form) {
          mainForm = form;
          window.setLanguage = function (lang) {
            form.language = lang;
          };

          // 已經有資料的話，就將資料更新進來
          // initial form data
          fetch(
            // '/apis/booking-form?token=grmPLZLVNRuBDz'
            '/apis/booking-form' + handleQS()
            , {
              headers: {
                'content-type': 'application/json'
              },
              method: 'GET',
              mode: 'cors',
            })
            .then(response => {

              var submission = { data: {} };
              response.json().then(function (result) {

                if (result && result.data) {
                  submission.data = result.data;
                  if (result.data.amtReview) {
                    amtUpdate(result.data.amtReview, submission);
                  }
                  // 預設的arrivalDate
                  submission.data.departureDate = (submission.data.departureDate ? submission.data.departureDate : form.submission.data.departureDate);
                  submission.data.arrivalDate = (submission.data.arrivalDate ? submission.data.arrivalDate : submission.data.departureDate);
                  // submission.data.pickupDateResult = (submission.data.pickupDateResult ? submission.data.pickupDateResult : moment(form.submission.data.departureDate).add(-1, 'days').format('YYYY-MM-DD HH:mm:ss+Z'));

                  var pickupDate = updatePickupDate(submission);
                  if (pickupDate)
                    submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');

                  form.submission = submission;

                  form.submission = submission;
                  mainComponents = result.components;
                  globalMap = result.map;
                  previewUpdate(form.submission);

                  // 第一次trigger一下event來更新arrivalDate區間？（已經有值的話不能被改)

                  // console.log('update done ' + JSON.stringify(result.components));
                }
              })
            });

          // Triggered when they click the submit button.
          form.on('change', function (event) {
            // 有時候key是number (加購項目...)

            // 轉換一下pickupDate           
            if (event.changed && typeof event.changed.component.key === 'string'
              && (event.changed.component.key.indexOf('pickupInAdvance') > -1)) {
              // form.submission.data.pickupInAdvance = ;
              var submission = { data: event.data };

              submission.data.pickupInAdvance = event.data[event.changed.component.key] || 1;

              var pickupDate = updatePickupDate(event);
              if (pickupDate)
                submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');

              form.submission = submission;
            }
            if (event.changed && typeof event.changed.component.key === 'string'
              && event.changed.component.key === 'departureDate') {
              var submission = { data: event.data };
              delete submission.data.pickupInAdvance;

              var pickupDate = updatePickupDate(event);
              if (pickupDate)
                submission.data.pickupDate = pickupDate.format('YYYY-MM-DD');

              form.submission = submission;
            }

            // 動態計算價格
            // console.log(event);
            // 判斷 key 是否影響價格？
            // 即可動態決定價位顯示
            // 一定要判斷否則會無窮迴圈

            // console.log(event.changed.component);
            // 日期相關
            if (event.changed && event.changed.component
              && event.changed.component.key === 'departureDate') {
              for (var i = 0; i < mainComponents.length; ++i) {

                if (mainComponents[i].key === 'datePanel' && mainComponents[i].components) {
                  for (var j = 0; j < mainComponents[i].components.length; ++j) {

                    if (mainComponents[i].components[j].key === 'bookingDate' && mainComponents[i].components[j].columns) {
                      // 針對arrival改變
                      if (mainComponents[i].components[j].columns[1] && mainComponents[i].components[j].columns[1].components) {
                        for (var k = 0; k < mainComponents[i].components[j].columns[1].components.length; ++k) {
                          if (mainComponents[i].components[j].columns[1].components[k].key === 'arrivalDate') {
                            mainForm.emit('departureChange', event);
                            // mainForm.setForm({components: mainComponents});
                            // break;
                          }
                        }
                      }

                    }
                  }
                }
              }
            }

            if (event.changed && event.changed.component
              && (
                event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'qty')
            ) {

              // 更改過影響加購的資訊的話，要清空addons!!
              var submission = { data: event.data };
              delete submission.data.addons;
              form.submission = submission;
            }

            if (event.changed &&
              typeof event.changed.component.key === 'string' &&
              (event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'pickupMethodValue'
                || event.changed.component.key === 'returnMethodValue'
                || event.changed.component.key === 'subPickupMethodValue'
                || (event.changed.component.key.indexOf('pickupInAdvance') > -1)
                || event.changed.component.key === 'qty'
              )
            ) {
              // console.log('go fetch https://wifiotg-kay.iiot.io/apis/booking-est');
              // console.log(form.components[1].component);

              previewUpdate(event);
              // console.log('change ' + form.components[1].component.content  + ' to update by fe');
              // form.components[1].component.content = 'update by fe';
              // form.render();
              // event.data裡面有目前的data, 要透過這個來計算價位
              fetch('/apis/booking-est', {
                body: JSON.stringify(event.data),
                method: 'POST',
                headers: {
                  'content-type': 'application/json'
                },
                mode: 'cors',
              })
                .then(function (response) {

                  response.json().then(function (result) {

                    var submission = { data: event.data };
                    // {"total":120,"amt":120,"days":1,"shipment":0,"price":50}
                    if (result && result.total) {
                      submission.data.amtReview = result.total;
                      amtUpdate(result.amt, submission);
                      form.submission = submission;
                      console.log(form.submission);
                    } else {
                      submission.data.amtReview = 0;
                      form.submission = submission;
                    }

                  });
                });
            }

            // add on 相關
            if (event.changed && (typeof event.changed.component.key === 'number' || (event.changed.component.key.indexOf('addons') > -1) || (event.changed.component.key.indexOf('%$@') > -1))) {

              // console.log('change ' + form.components[1].component.content  + ' to update by fe');
              // form.components[1].component.content = 'update by fe';
              // form.render();
              // event.data裡面有目前的data, 要透過這個來計算價位
              fetch('/apis/booking-est', {
                body: JSON.stringify(event.data),
                method: 'POST',
                headers: {
                  'content-type': 'application/json'
                },
                mode: 'cors',
              })
                .then(function (response) {

                  response.json().then(function (result) {

                    var submission = { data: event.data };
                    // {"total":120,"amt":120,"days":1,"shipment":0,"price":50}
                    if (result && result.amt) {
                      submission.data.amtReview = result.amt;
                      amtUpdate(result.amt);
                      form.submission = submission;
                      console.log(form.submission);
                    } else {
                      submission.data.amtReview = 0;
                      form.submission = submission;
                    }

                  });
                });
            }
          });

          // Prevent the submission from going to the form.io server.
          form.nosubmit = true;

          form.on('jppost', (event) => {
            event.skipAmt = true;
            console.log('jppost event');
            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              body: JSON.stringify(event),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.jppostUrl;
                });
              })
          })
          form.on('error', function (e) {
            // e is array, [{component:{label:"xx", key: "pickupMethodValue..."}, message: "取貨方式 is requied"}];
            // console.log('we got the error ', e);

            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
          })
          // Triggered when they click the submit button.
          form.on('submit', function (submission) {

            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              // body: JSON.stringify(submission),
              body: JSON.stringify(submission.data),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {
                // submission.data.redirectUrl = response.redirectUrl;
                form.emit('submitDone', submission);

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.redirectUrl;
                });
              })
          });
          // form.on('submitDone', function (submission) {
          //   window.location = submission.data.redirectUrl;
          // });
        });
    };
  </script>

</head>

<body>

  <div class="shop_contents">

    <div class="header">
      <div class="newLogo">
        <a href="https://www.iiot.io">
          <img class="iiot-logo-image" src="https://userfiles-dev.iiot.io/businesses/p8WGlOzZ6/U_NLM0gEw0z">
        </a>
      </div>
    </div>
    <a class="mob_cart" href="#"><span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span></a>

    <!-- 新增nav bar -->
    <div class="top_step_contents clearfix">
      <div class="">
        <div class="stepwizard align-center">
          <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-info btn-circle" disabled="disabled">1</a>
              <p class="">Booking Form</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">2</a>
              <p class="">Add ons</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">3</a>
              <p class="">Confirm</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-step-default btn-circle" disabled="disabled">4</a>
              <p class="">Payment</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="iiot-main-form">
      <div class="row">
        <div class="col-md-12">
          <div id='bookingform' class="card card-body bg-light null formio-form"></div>
        </div>
      </div>
    </div>

    <div class="orderpreview">
      <div class="wellbox">
        <h3 class="top_title"><span>お申込内容</span></h3>
        <div class="a_list clearfix">
          <p class="left_item">レンタル期間</p>
          <p id="order-date">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">プラン名</p>
          <p>
            亞洲跨國 500MB
          </p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">受取方法</p>
          <p id="pickup-method">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">返却方法</p>
          <p id="return-method">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">お受取り日</p>
          <p id="pickup-date">未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">jetfi レンタル台数</p>
          <p id="device-qty">未選択です</p>
        </div>
        <!-- <div class="a_list clearfix">
          <p class="left_item">キャンペーン値引き</p>
          <p>-500円</p>
        </div> -->
        <div class="a_list clearfix">
          <p class="left_item">合計金額(税込)</p>
          <p><span id="amt-total">0</span> 円</p>
        </div>
        <div class="a_list clearfix">
          <!-- <p class="left_item">合計金額(税込)</p>
          <p><span id="amt-total">0</span> 円</p> -->
          <button type="button" id="estimate-dl-button" class="booking-estimate btn btn-outline-dark" onclick="openEstimate()">見積書をダウンロード</button>
        </div>
        <div class="a_list clearfix">
          <!-- <p class="left_item">合計金額(税込)</p>
          <p><span id="amt-total">0</span> 円</p> -->
          <button type="button" class="btn btn-info" onclick="mainForm.submit()">お申込者情報の入力へ</button>
        </div>
      </div>
    </div>

    <!-- 日本不想要這個，而是希望併入右方preview區域 -->
    <!-- <div class="footer">
      <div class="row">
        <div class="col-md-6 amount-text">
          <p>税込合計: <span id="amt-footer">0</span><i class="icon-shopping-cart icon"></i></p>
        </div>
        <div class="col-md-6 confirm-button-bottom">
          <button type="button" id="estimate-dl-button" class="booking-estimate btn btn-outline-light" onclick="openEstimate()">見積書をダウンロード</button>
          <button type="button" class="btn btn-info" onclick="mainForm.submit()">お申込者情報の入力へ</button>
        </div>
      </div>
    </div> -->


  </div> <!-- /container -->
</body>

</html>