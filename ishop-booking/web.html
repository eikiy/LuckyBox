
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- <link rel="icon" href="../../favicon.ico"> -->
  <link rel="icon" href="null">
  <meta property="og:description" content="">

  <title>
    JETFI JP |
  </title>

  <!-- Bootstrap core CSS -->
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>

  <!-- 變成material design -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- bootswatch -->
  <link rel="stylesheet" href="./assets/theme.min.css">
  <!-- <link rel="stylesheet" href="https://bootswatch.com/3/cerulean/bootstrap.min.css"> -->

  <link rel='stylesheet' href='https://wifiotg-kay.iiot.io/styles/formio.full.min.css'>
  <script src='https://wifiotg-kay.iiot.io/scripts/formio.full.min.js'></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript">
    $(function(){
      $(".mob_cart").click(function(){
        $(this).parent().find('.orderpreview').slideToggle(800);
      });
      return false;
    });
  </script>

  <!-- moment -->
  <script src="https://momentjs.com/downloads/moment-with-locales.js"></script>
  <link rel='stylesheet' href='./assets/style.css'>

  <script type='text/javascript'>
    var amtUpdate = function (amt, submission) {
      // footer 更新
      document.getElementById('amt-footer').innerHTML = '<p>' + amt + '</p>';

      // preview 更新
      var departureDate = '';
      if (submission.data.departureDate) {
        departureDate = moment(submission.data.departureDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY-MM-DD');
      }
      var arrivalDate = '';
      if (submission.data.arrivalDate) {
        arrivalDate = moment(submission.data.arrivalDate, 'YYYY-MM-DDTHH:mm:ss+Z').format('YYYY-MM-DD');
      }

      document.getElementById('order-date').innerHTML = '<p>' + departureDate + ' ~ ' + arrivalDate + '</p>'

    }

    var mainForm, mainComponents;
    window.onload = function () {
      Formio.setBaseUrl('https://wifiotg-kay.iiot.io');
      // Formio.createForm(document.getElementById('formio'), 'https://wifiotg-kay.iiot.io/modules/booking-form')
      Formio.createForm(document.getElementById('bookingform'),
        '/apis/booking-form?token=example'
        , {
          readOnly: false,
          viewAsHtml: false // 這個可以拿來做訂單確認

        }
      )
        .then(function (form) {
          mainForm = form;
          window.setLanguage = function (lang) {
            form.language = lang;
          };

          // 已經有資料的話，就將資料更新進來
          fetch('/apis/booking-form?token=example', {
            headers: {
              'content-type': 'application/json'
            },
            method: 'GET',
            mode: 'cors',
          })
            .then(response => {

              var submission = { data: {} };
              response.json().then(function (result) {

                if (result && result.data) {
                  submission.data = result.data;
                  if (result.data.amtReview) {
                    amtUpdate(result.data.amtReview, submission);
                  }
                  form.submission = submission;
                  mainComponents = result.components;

                  // console.log('update done ' + JSON.stringify(result.components));
                }
              })
            });

          // Triggered when they click the submit button.
          form.on('change', function (event) {
            // 動態計算價格
            // console.log(event);
            // 判斷 key 是否影響價格？
            // 即可動態決定價位顯示
            // 一定要判斷否則會無窮迴圈

            console.log(event.changed.component);



            if (event.changed && event.changed.component
              && event.changed.component.key === 'departureDate') {
              for (var i = 0; i < mainComponents.length; ++i) {

                if (mainComponents[i].key === 'datePanel' && mainComponents[i].components) {
                  for (var j = 0; j < mainComponents[i].components.length; ++j) {
                    console.log('hello ' + mainComponents[i].components[j].key);
                    if (mainComponents[i].components[j].key === 'bookingDate' && mainComponents[i].components[j].columns) {
                      // 針對arrival改變
                      if (mainComponents[i].components[j].columns[1] && mainComponents[i].components[j].columns[1].components) {
                        for (var k = 0; k < mainComponents[i].components[j].columns[1].components.length; ++k) {
                          if (mainComponents[i].components[j].columns[1].components[k].key === 'arrivalDate') {
                            // mainComponents[i].components[j].columns[1].components[k].widget.minDate = event.data.departureDate;
                            // mainComponents[i].components[j].columns[1].components[k].datePicker.minDate = event.data.departureDate;
                            // console.log('the main components ' + JSON.stringify(mainComponents));

                            // demo
                            // form.components[2].originalComponent.logic[0].actions[0].text = "moment().add(-1, 'days').format()";
                            // change logic action
                            // console.log('ff', form.components[i].originalComponent);
                            // 2, 0, 0
                            // console.log('i ' + i + ' j ' + j + ' k ' + k); 
                            // form.components[i].originalComponent.components[j].columns[1].components[k].logic[0].actions[0].text = "moment().format()";
                            // form.components[i].originalComponent.components[j].columns[1].components[k].logic[0].actions[1].text = "moment().format()";
                            // form.components[i].component.components[j].columns[1].components[k].logic[0].actions[0].text = "moment().format()";
                            // form.components[i].component.components[j].columns[1].components[k].logic[0].actions[1].text = "moment().format()";
                            // form.components[i].components[j].originalComponent.columns[1].components[k].logic[0].actions[0].text = "moment().format()";
                            // form.components[i].components[j].originalComponent.columns[1].components[k].logic[0].actions[1].text = "moment().format()";
                            // form.components[i].components[j].component.columns[1].components[k].logic[0].actions[0].text = "moment().format()";
                            // form.components[i].components[j].component.columns[1].components[k].logic[0].actions[1].text = "moment().format()";
                            // mainComponents[i].components[j].columns[1].components[k].logic[0].actions[0].text = "moment().format('YYYY-MM-DD')";
                            // mainComponents[i].components[j].columns[1].components[k].logic[0].actions[1].text = "moment().format('YYYY-MM-DD')";
                            // console.log(mainComponents[i].components[j].columns[1].components[k].logic[0].actions[1].text);
                            // mainComponents[i].components[j].columns[1].components[k].logic[0].actions[1].text = "moment(" + event.data.departureDate + ", 'YYYY-MM-DDTHH:mm:ss+Z').format()";
                            // mainComponents[i].components[j].columns[1].components[k].logic[0].actions[1].text = "moment(" + event.data.departureDate + ", 'YYYY-MM-DDTHH:mm:ss+Z).format()";
                            // console.log('the text ' +  mainComponents[i].components[j].columns[1].components[k].logic[0].actions[1].text);
                            // console.log(event.data.departureDate);
                            // console.log('aa', form.components[i].originalComponent.components[j].columns[1].components[k].logic[0].actions[0].text);

                            mainForm.emit('departureChange', event);
                            // mainForm.setForm({components: mainComponents});
                            // break;
                          }
                        }
                      }

                    }
                  }
                }
              }
            }

            if (event.changed && event.changed.component
              && (
                event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'amount')
            ) {

              // 更改過影響加購的資訊的話，要清空addons!!
              var submission = { data: event.data };
              delete submission.data.addons;
              form.submission = submission;

            }

            if (event.changed &&
              (event.changed.component.key === 'departureDate'
                || event.changed.component.key === 'arrivalDate'
                || event.changed.component.key === 'pickupMethodValue'
                || event.changed.component.key === 'returnMethodValue'
                || event.changed.component.key === 'amount'
              )
            ) {
              console.log('go fetch https://wifiotg-kay.iiot.io/apis/booking-est');
              console.log(form.components[1].component);
              // console.log('change ' + form.components[1].component.content  + ' to update by fe');
              // form.components[1].component.content = 'update by fe';
              // form.render();
              // event.data裡面有目前的data, 要透過這個來計算價位
              fetch('/apis/booking-est', {
                body: JSON.stringify(event.data),
                method: 'POST',
                headers: {
                  'content-type': 'application/json'
                },
                mode: 'cors',
              })
                .then(function (response) {

                  response.json().then(function (result) {

                    var submission = { data: event.data };
                    // {"total":120,"amt":120,"days":1,"shipment":0,"price":50}
                    if (result && result.total) {
                      submission.data.amtReview = result.total;
                      amtUpdate(result.amt, submission);
                      form.submission = submission;
                      console.log(form.submission);
                    } else {
                      submission.data.amtReview = 0;
                      form.submission = submission;
                    }

                  });
                });
            }
          });

          // Prevent the submission from going to the form.io server.
          form.nosubmit = true;

          form.on('jppost', (event) => {
            event.skipAmt = true;
            console.log('jppost event');
            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              body: JSON.stringify(event),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.jppostUrl;
                });
              })
          })
          // Triggered when they click the submit button.
          form.on('submit', function (submission) {

            // console.log(submission);
            // alert('Submission sent to custom endpoint. See developer console.');
            return fetch('/apis/booking-form', {
              // body: JSON.stringify(submission),
              body: JSON.stringify(submission.data),
              headers: {
                'content-type': 'application/json'
              },
              method: 'POST',
              mode: 'cors',
            })
              .then(response => {
                // submission.data.redirectUrl = response.redirectUrl;
                form.emit('submitDone', submission);

                response.json().then((result) => {
                  // window.location = 'http://127.0.0.1:8080/order.html'
                  window.location = result.redirectUrl;
                });
              })
          });
          // form.on('submitDone', function (submission) {
          //   window.location = submission.data.redirectUrl;
          // });
        });
    };
  </script>

</head>

<body>

  <div class="shop_contents">
    <div class="header">
        <div class="newLogo">
          <a href="https://www.iiot.io">
            <img class="iiot-logo-image" src="https://userfiles-dev.iiot.io/businesses/p8WGlOzZ6/U_NLM0gEw0z">
          </a>
        </div>
    </div>
    <a class="mob_cart" href="#"><span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span></a>
    <!-- 新增nav bar -->
    <div class="top_step_contents clearfix">
      <div class="">
        <div class="stepwizard align-center">
          <div class="stepwizard-row setup-panel">
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-warning btn-circle" disabled="disabled">1</a>
              <p class="">Booking Form</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-default btn-circle" disabled="disabled">2</a>
              <p class="">Add ons</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-default btn-circle" disabled="disabled">3</a>
              <p class="">Confirm</p>
            </div>
            <div class="stepwizard-step">
              <a href="#" type="button" class="btn btn-default btn-circle" disabled="disabled">4</a>
              <p class="">Payment</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="iiot-main-form">
      <div class="row">
        <div class="col-md-12">
          <div id='bookingform' class="card card-body bg-light null formio-form"></div>
        </div>
      </div>
    </div>

    <div class="orderpreview">
      <div class="wellbox">
        <h3 class="top_title"><span>お申込内容</span></h3>
        <div class="a_list clearfix">
          <p class="left_item">レンタル期間</p>
          <p id="order-date"></p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">渡航エリア</p>
          <p>Asia <br> 韓國</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">受取方法</p>
          <p>未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">jetfi レンタル台数</p>
          <p>未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">通信プラン</p>
          <p>未選択です</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">キャンペーン値引き</p>
          <p>-500円</p>
        </div>
        <div class="a_list clearfix">
          <p class="left_item">合計金額(税込)</p>
          <p>18,200 円</p>
        </div>
      </div>
    </div>


    <div class="footer">
      <div class="row">
        <div class="col-md-6 amount-text">
          <p>Total: <span id="amt-footer">0</span><i class="icon-shopping-cart icon"></i></p>
        </div>
        <div class="col-md-6 confirm-button-bottom">
          <button type="button" class="btn btn-warning" onclick="mainForm.submit()">Continue</button>
        </div>
      </div>

    </div>


  </div> <!-- /container -->
</body>

</html>